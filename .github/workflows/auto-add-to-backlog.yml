name: Auto-add issues to Backlog

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

env:
  PROJECT_ID: PVT_kwDOCW6FW84BPU-D

jobs:
  add-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Add open issues to Backlog
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          # Find all open issues across the org that aren't already in the project
          gh search issues --owner NimbleBrainInc --state open --limit 200 \
            --json url --jq '.[].url' \
            -- -project:NimbleBrainInc/10 | while read -r issue_url; do
            echo "Adding: $issue_url"
            # Get the issue's node ID and add via GraphQL (gh project item-add has a PAT bug)
            NODE_ID=$(gh api graphql -f query='query($url:URI!){resource(url:$url){...on Issue{id}}}' -f url="$issue_url" --jq '.data.resource.id')
            if [ -n "$NODE_ID" ]; then
              gh api graphql -f query='mutation($project:ID!,$item:ID!){addProjectV2ItemById(input:{projectId:$project,contentId:$item}){item{id}}}' \
                -f project="${{ env.PROJECT_ID }}" -f item="$NODE_ID" --silent || true
            fi
          done
